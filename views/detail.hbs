<ol class="breadcrumb">
    <li><a href="/dashboard">$$label_dashboard$$</a></li>
    <li class="active">{{ticket.title}}</li>
</ol>

<div class="panel panel-info">
    <div class="panel-heading">
        <div class="panel-title">
            {{ticket.title}}
        </div>
    </div>
    <div class="panel-body">
        <div style="float: right;">
            <p>
                <span class="badge btn btn-danger level-badge" data-level="blocker">
                    {{#compare ticket.level "blocker"}}<i class="fa fa-check"></i>{{/compare}}
                    {{#compare ticket.level "blocker" operator="!="}}<i class="fa fa-circle-o"></i>{{/compare}}
                    $$label_blocker$$
                </span>
            </p>
            <p>
                <span class="badge btn btn-warning level-badge" data-level="critical">
                    {{#compare ticket.level "critical"}}<i class="fa fa-check"></i>{{/compare}}
                    {{#compare ticket.level "critical" operator="!="}}<i class="fa fa-circle-o"></i>{{/compare}}
                    $$label_critical$$
                </span>
            </p>
            <p>
                <span class="badge btn btn-success level-badge" data-level="low">
                    {{#compare ticket.level "low"}}<i class="fa fa-check"></i>{{/compare}}
                    {{#compare ticket.level "low" operator="!="}}<i class="fa fa-circle-o"></i>{{/compare}}
                    $$label_low$$
                </span>
            </p>

        </div>
        <p><span><strong>$$label_app_name$$</strong></span>&nbsp;<span>{{appName}}</span></p>
        <p><span><strong>$$label_app_version$$</strong></span>&nbsp;<span>{{ticket.appVersion}}</span></p>
        <p>
            <span class="label label-$$class_status_{{ticket.status}}$$">$$label_status_{{ticket.status}}$$&nbsp;&nbsp;<i class="fa $$icon_type_{{ticket.type}}$$"></i></span>
            {{#if ticket.private}}
                <span class="label label-danger">$$label_private$$&nbsp;&nbsp;<i class="fa fa-lock"></i></span>
            {{else}}
                <span class="label label-success">$$label_public$$&nbsp;&nbsp;<i class="fa fa-unlock"></i></span>
            {{/if}}
        </p>
        <hr/>
        <div class="ticket-description">
            {{#markdown}}{{ticket.description}}{{/markdown}}
        </div>
        <hr/>
    </div>
    <div class="panel-footer buttons">
        {{#compare ticket.status "open"}}
            <button id="start-progress-button" class="btn btn-sm btn-default">
                <i class="fa fa-play"></i><br>$$label_start_progress$$
            </button>
            <button id="close-button" class="btn btn-sm btn-default">
                <i class="fa fa-close"></i><br>$$label_close$$
            </button>
        {{/compare}}
        {{#compare ticket.status "progress"}}
            <button id="reopen-button" class="btn btn-sm btn-default">
                <i class="fa fa-stop"></i><br>$$label_stop_progress$$
            </button>
            <button id="close-button" class="btn btn-sm btn-default">
                <i class="fa fa-close"></i><br>$$label_close$$
            </button>
        {{/compare}}
        {{#compare ticket.status "closed"}}
            <button id="reopen-button" class="btn btn-sm btn-default">
                <i class="fa fa-refresh"></i><br>$$label_open$$
            </button>
        {{/compare}}
        {{#if ticket.private}}
            <button id="private-button" class="btn btn-sm btn-default">
                <i class="fa fa-unlock"></i><br>$$label_public$$
            </button>
        {{else}}
            <button id="public-button" class="btn btn-sm btn-default">
                <i class="fa fa-lock"></i><br>$$label_private$$
            </button>
        {{/if}}
    </div>
</div>

<h4>$$label_comments$$</h4>
<hr/>

{{#each ticket.comments}}
    <div class="panel panel-default">
        <div class="panel-heading">
            <span></span>
            <span>$$label_created$$ {{created}}</span>
            <span>$$label_by$$ {{owner}}</span>
        </div>
        <div class="panel-body">
            {{#markdown}}{{text}}{{/markdown}}
        </div>
        <div class="panel-footer buttons">
            <button data-comment-id="{{id}}" class="btn btn-sm btn-default delete-button">
                <i class="fa fa-trash"></i>
            </button>
        </div>
    </div>
{{/each}}

<form class="form" method="POST" action="/ticket/{{ticket.id}}/comment">
    <div class="form-group">
        <label for="comment">$$label_comment$$ (min: 10/ max: 1000)</label>
        <textarea class="form-control" rows="5" name="comment" minlength="10" maxlength="1000"></textarea>
        <span class="markdown-notice">$$label_markdown_support$$</span>
    </div>

    <input class="btn btn-sm btn-primary" type="submit" value="$$label_add_comment$$">
</form>

<script>

    var deleteComment = function(evt) {
        evt.preventDefault();
        var cid = evt.target.getAttribute('data-comment-id');
        $.ajax({
            url: '/ticket/{{ticket.id}}/comment/' + cid,
            method: 'DELETE',
            contentType: 'application/json',
            success: function(result) {
                window.location.reload();
            }
        });
    };

    var setTicketStatus = function(evt, status) {
        evt.preventDefault();
        $.ajax({
            url: '/ticket/{{ticket.id}}',
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({status: status}),
            success: function(result) {
                window.location.reload();
            }
        });
    };

    var addEventListeners = function(element, event, fn) {
        var el = document.getElementById(element);
        if(!el){
            return;
        }

        el.addEventListener(event, fn);
    };

    window.addEventListener('load', function(){
        document.querySelectorAll('.delete-button').forEach(function(btn){
            btn.addEventListener('click', deleteComment);
        });

        document.querySelectorAll('.level-badge').forEach(function(btn){
            btn.addEventListener('click', function(evt){
                setTicketStatus(evt, evt.target.getAttribute('data-level'));
            });
        });

        addEventListeners('start-progress-button', 'click', function(evt){
            setTicketStatus(evt, 'progress');
        });

        addEventListeners('close-button', 'click', function(evt){
            setTicketStatus(evt, 'closed');
        });

        addEventListeners('reopen-button', 'click', function(evt){
            setTicketStatus(evt, 'open');
        });

        addEventListeners('private-button', 'click', function(evt){
            setTicketStatus(evt, 'public');
        });

        addEventListeners('public-button', 'click', function(evt){
            setTicketStatus(evt, 'private');
        });
    });


</script>
